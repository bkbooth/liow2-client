box: node:6

build:
  steps:
    - script:
      name: install dependencies
      code: |
        # install yarn
        npm install -g yarn
        # set yarn cache
        export YARN_CACHE=$WERCKER_CACHE_DIR/yarn
        # install dependencies
        HOME=$YARN_CACHE yarn

    - script:
      name: lint
      code: yarn lint

    - script:
      name: test
      code: yarn test -- --single-run --code-coverage

    - script:
      name: build
      code: yarn build:prod

    - script:
      name: send test coverage report
      code: yarn coveralls < ./coverage/lcov.info

deploy:
  steps:
    - s3sync:
      name: sync to S3
      key-id: $AWS_ACCESS_KEY_ID
      key-secret: $AWS_SECRET_KEY
      bucket-url: $S3_BUCKET_NAME
      source-dir: dist

    - dlapiduz/cf-invalidate:
      name: invalidate CloudFront cache
      key-id: $AWS_ACCESS_KEY_ID
      key-secret: $AWS_SECRET_KEY
      distribution-id: $CF_DISTRIBUTION_ID
      path: /*
